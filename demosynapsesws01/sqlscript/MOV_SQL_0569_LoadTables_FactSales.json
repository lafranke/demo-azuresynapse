{
	"name": "MOV_SQL_0569_LoadTables_FactSales",
	"properties": {
		"description": "OpenHack MDWH\nAzure Synapse Analytics Demo\nhttps://github.com/aessing/demo-azuresynapse\n\nDeveloper: Andre Essing\n(https://www.andre-essing.de/)\n(https://github.com/aessing)\n(https://twitter.com/aessing)\n(https://www.linkedin.com/in/aessing/)\n\nTHIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\nEITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\nWARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.",
		"folder": {
			"name": "Movies"
		},
		"content": {
			"query": "-- =============================================================================\n-- OpenHack MDWH\n-- Azure Synapse Analytics Demo\n-- https://github.com/aessing/demo-azuresynapse\n-- -----------------------------------------------------------------------------\n-- Developer.......: Andre Essing (https://www.andre-essing.de/)\n--                                (https://github.com/aessing)\n--                                (https://twitter.com/aessing)\n--                                (https://www.linkedin.com/in/aessing/)\n-- -----------------------------------------------------------------------------\n-- THIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\n-- EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\n-- WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.\n-- =============================================================================\n\n-- Load table\nDECLARE @MaxSK INT;\nSELECT @MaxSK = ISNULL(MAX(SalesSK), 0) FROM [dbo].[FactSales]\n\nINSERT INTO [dbo].[FactSales] (\n    [SalesSK],\n    [OrderID],\n    [LineNumber],\n    [OrderDateSK],\n    [ShipDateSK],\n    [CustomerSK],\n    [LocationSK],\n    [MovieSK],\n    [DaysToShip],\n    [Quantity],\n    [UnitCost],\n    [ExtendedCost]\n)\nSELECT * FROM (\n\tSELECT \n\t\t@MaxSK + ROW_NUMBER() OVER (ORDER BY ExternalTable.OrderID) AS SalesSK,\n\t\tExternalTable.OrderID AS OrderID,\n\t\tExternalTable.LineNumber AS LineNumber,\n\t\tExternalTable.OrderDateSK AS OrderDateSK,\n\t\tExternalTable.ShipDateSK AS ShipDateSK,\n\t\tExternalTable.CustomerSK AS CustomerSK,\n\t\tExternalTable.LocationSK AS LocationSK,\n\t\tExternalTable.MovieSK AS MovieSK,\n\t\tExternalTable.DaysToShip AS DaysToShip,\n\t\tExternalTable.Quantity AS Quantity,\n\t\tExternalTable.UnitCost AS UnitCost,\n\t\tExternalTable.ExtendedCost AS ExtendedCost\n\tFROM (\n\t\tSELECT\n\t\t\tsal.SourceSystemOrderID AS OrderID,\n\t\t\tsal.LineNumber AS LineNumber,\n\t\t\torddat.DateSK AS OrderDateSK,\n\t\t\tshidat.DateSK ShipDateSK,\n\t\t\tdcus.CustomerSK AS CustomerSK,\n\t\t\tsal.SourceSystemID AS LocationSK,\n\t\t\tmov.MovieSK AS MovieSK,\n\t\t\tCASE\n\t\t\t\tWHEN DATEDIFF(d, sal.OrderDate, sal.ShipDate) < 0 THEN NULL\n\t\t\t\tELSE DATEDIFF(d, sal.OrderDate, sal.ShipDate)\n\t\t\tEND AS DaysToShip,\n\t\t\tsal.Quantity,\n\t\t\tsal.UnitCost,\n\t\t\tsal.Quantity * sal.UnitCost AS ExtendedCost\n\t\tFROM\n\t\t\t[ext].[sales] sal\n\t\tJOIN\n\t\t\t[dbo].[DimDate] orddat\n\t\t\tON sal.OrderDate = orddat.DateValue\n\t\tJOIN\n\t\t\t[dbo].[DimDate] shidat\n\t\t\tON sal.ShipDate = shidat.DateValue\n\t\tJOIN\n\t\t\t[ext].[customers] cust\n\t\t\tON sal.CustomerID = cust.SourceSystemCustomerID\n\t\tJOIN\n\t\t\t[dbo].[DimCustomers] dcus\n\t\t\tON cust.LastName = dcus.Lastname\n\t\t\tAND cust.FirstName = dcus.FirstName\n\t\t\tAND cust.AddressLine1 = dcus.AddressLine1\n\t\t\tAND cust.ZipCode = dcus.ZipCode\n\t\tJOIN\n\t\t\t[ext].[catalog] cat\n\t\t\tON sal.MovieID = cat.SourceSystemMovieID\n\t\tJOIN\n\t\t\t[dbo].[DimMovies] mov\n\t\t\tON cat.Title = mov.MovieTitle\n\t) ExternalTable\n) CleansedTable\nWHERE CleansedTable.OrderID NOT IN (SELECT OrderID FROM [dbo].[FactSales])\n\n-- Check Load\n-- SELECT * FROM [dbo].[FactSales]",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Movies",
				"databaseName": "Movies"
			}
		},
		"type": "SqlQuery"
	}
}