{
	"name": "MOV_SQL_0699_CloudStreaming_MoveData",
	"properties": {
		"description": "OpenHack MDWH\nAzure Synapse Analytics Demo\nhttps://github.com/aessing/demo-azuresynapse\n\nDeveloper: Andre Essing\n(https://www.andre-essing.de/)\n(https://github.com/aessing)\n(https://twitter.com/aessing)\n(https://www.linkedin.com/in/aessing/)\n\nTHIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\nEITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\nWARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.",
		"folder": {
			"name": "Movies/Challllenge 06 - Internals"
		},
		"content": {
			"query": "-- =============================================================================\n-- OpenHack MDWH\n-- Azure Synapse Analytics Demo\n-- https://github.com/aessing/demo-azuresynapse\n-- -----------------------------------------------------------------------------\n-- Developer.......: Andre Essing (https://www.andre-essing.de/)\n--                                (https://github.com/aessing)\n--                                (https://twitter.com/aessing)\n--                                (https://www.linkedin.com/in/aessing/)\n-- -----------------------------------------------------------------------------\n-- THIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\n-- EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\n-- WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.\n-- =============================================================================\n\nCREATE PROCEDURE [dbo].[MoveData]\n\t@DateToMove DATE,\n\t@SwitchIn BIT = 1\nAS\n\t-- Declare local variables...\n\tDECLARE\n\t\t@PartitionNumber integer;\n\n\t-- Get the Partition Number...\n\tSELECT @PartitionNumber = boundary_id\n\tFROM sys.partition_range_values\n\tWHERE [value] = @DateToMove;\n\n\t-- Determine if we are moving data in or out...\n\tIF (@SwitchIn = 1)\n\tBEGIN\n\t\t-- Switch the Customer data...\n\t\tALTER TABLE Hidden.Customers SWITCH PARTITION @PartitionNumber TO dbo.Customers PARTITION @PartitionNumber;\n\n\t\t-- Switch the Address data...\n\t\tALTER TABLE Hidden.Addresses SWITCH PARTITION @PartitionNumber TO dbo.Addresses PARTITION @PartitionNumber;\n\n\t\t-- Switch the Transaction data...\n\t\tALTER TABLE Hidden.Transactions SWITCH PARTITION @PartitionNumber TO dbo.Transactions PARTITION @PartitionNumber;\n\n\t\t-- Apply updates to the Customer records...\n\t\tUPDATE dbo.Customers\n\t\tSET\n\t\t\tLastName = U.LastName,\n\t\t\tFirstName = U.FirstName,\n\t\t\tPhoneNumber = U.PhoneNumber,\n\t\t\tUpdatedDate = U.UpdatedDate\n\t\tFROM dbo.Customers C\n\t\tINNER JOIN Hidden.CustomerUpdates U\n\t\t\tON (U.CustomerID = C.CustomerID)\n\t\tWHERE U.UpdatedDate = @DateToMove;\n\n\t\t-- Apply updates to the Address records...\n\t\tUPDATE dbo.Addresses\n\t\tSET\n\t\t\tAddressLine1 = U.AddressLine1,\n\t\t\tAddressLine2 = U.AddressLine2,\n\t\t\tCity = U.City,\n\t\t\tState = U.State,\n\t\t\tZipCode = U.ZipCode,\n\t\t\tUpdatedDate = U.UpdatedDate\n\t\tFROM dbo.Addresses C\n\t\tINNER JOIN Hidden.AddressUpdates U\n\t\t\tON (U.AddressID = C.AddressID)\n\t\tWHERE U.UpdatedDate = @DateToMove;\n\n\t\t-- Apply updates to the Transaction records...\n\t\tUPDATE dbo.Transactions\n\t\tSET\n\t\t\tStreamEnd = U.StreamEnd,\n\t\t\tUpdatedDate = U.UpdatedDate\n\t\tFROM dbo.Transactions C\n\t\tINNER JOIN Hidden.TransactionUpdates U\n\t\t\tON (U.TransactionID = C.TransactionID)\n\t\tWHERE U.UpdatedDate = @DateToMove;\n\tEND\n\tELSE\n\tBEGIN\n\t\t-- Switch the Customer data...\n\t\tALTER TABLE dbo.Customers SWITCH PARTITION @PartitionNumber TO Hidden.Customers PARTITION @PartitionNumber;\n\n\t\t-- Switch the Address data...\n\t\tALTER TABLE dbo.Addresses SWITCH PARTITION @PartitionNumber TO Hidden.Addresses PARTITION @PartitionNumber;\n\n\t\t-- Switch the Transaction data...\n\t\tALTER TABLE dbo.Transactions SWITCH PARTITION @PartitionNumber TO Hidden.Transactions PARTITION @PartitionNumber;\n\n\t\t-- Apply updates to the Orders records...\n\t\tUPDATE dbo.Transactions\n\t\tSET\n\t\t\tStreamEnd = NULL,\n\t\t\tUpdatedDate = CreatedDate\n\t\tWHERE TransactionID IN\n\t\t(\n\t\t\tSELECT TransactionID\n\t\t\tFROM Hidden.TransactionUpdates\n\t\t\tWHERE UpdatedDate = @DateToMove\n\t\t);\n\tEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Built-in",
				"databaseName": "master"
			}
		},
		"type": "SqlQuery"
	}
}