{
	"name": "MOV_SQL_050410_LoadTables_FactStreaming",
	"properties": {
		"description": "OpenHack MDWH\nAzure Synapse Analytics Demo\nhttps://github.com/aessing/demo-azuresynapse\n\nDeveloper: Andre Essing\n(https://www.andre-essing.de/)\n(https://github.com/aessing)\n(https://twitter.com/aessing)\n(https://www.linkedin.com/in/aessing/)\n\nTHIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\nEITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\nWARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.",
		"folder": {
			"name": "Movies/Challenge 05 - 04 Load Tables"
		},
		"content": {
			"query": "-- =============================================================================\n-- OpenHack MDWH\n-- Azure Synapse Analytics Demo\n-- https://github.com/aessing/demo-azuresynapse\n-- -----------------------------------------------------------------------------\n-- Developer.......: Andre Essing (https://www.andre-essing.de/)\n--                                (https://github.com/aessing)\n--                                (https://twitter.com/aessing)\n--                                (https://www.linkedin.com/in/aessing/)\n-- -----------------------------------------------------------------------------\n-- THIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\n-- EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\n-- WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.\n-- =============================================================================\n\nTRUNCATE TABLE [dbo].[FactStreaming];\n\n-- Load table\nDECLARE @MaxSK INT;\nSELECT @MaxSK = ISNULL(MAX(StreamingSK), 0) FROM [dbo].[FactStreaming]\n\nINSERT INTO [dbo].[FactStreaming] (\n    [StreamingSK],\n    [TransactionID],\n    [CustomerSK],\n    [MovieSK],\n    [StreamStartDateSK],\n    [StreamStartTimeSK],\n    [StreamEndDateSK],\n    [StreamEndTimeSK],\n    [StreamDurationSec],\n    [StreamDurationMin]\n)\nSELECT * FROM (\n\tSELECT \n\t\t@MaxSK + ROW_NUMBER() OVER (ORDER BY ExternalTable.TransactionID) AS StreamingSK,\n\t\tExternalTable.TransactionID AS TransactionID,\n\t\tExternalTable.CustomerSK AS CustomerSK,\n\t\tExternalTable.MovieSK AS MovieSK,\n\t\tExternalTable.StreamStartDateSK AS StreamStartDateSK,\n\t\tExternalTable.StreamStartTimeSK AS StreamStartTimeSK,\n\t\tExternalTable.StreamEndDateSk AS StreamEndDateSk,\n\t\tExternalTable.StreamEndTimeSk AS StreamEndTimeSk,\n\t\tExternalTable.StreamDurationSec AS StreamDurationSec,\n\t\tExternalTable.StreamDurationMin AS StreamDurationMin\n\tFROM (\n\t\tSELECT\n\t\t\tSourceSystemTransactionID AS TransactionID,\n\t\t\t(\n\t\t\t\tSELECT TOP 1\n\t\t\t\t\tCustomerSK \n\t\t\t\tFROM \n\t\t\t\t\t[dbo].[DimCustomers] dcust\n\t\t\t\tJOIN\n\t\t\t\t\t[ext].[Customers] cust\n\t\t\t\t\tON dcust.LastName = cust.LastName\n\t\t\t\t\tAND dcust.FirstName = cust.FirstName\n\t\t\t\t\tAND dcust.ZipCode = cust.ZipCode\n\t\t\t\t\tAND dcust.City = cust.City\n\t\t\t\t\tAND dcust.State = cust.State\n\t\t\t\tWHERE\n\t\t\t\t\tstr.CustomerID = cust.SourceSystemCustomerID\n\t\t\t) AS CustomerSK,\n\t\t\t(\n\t\t\t\tSELECT TOP 1\n\t\t\t\t\tMovieSK \n\t\t\t\tFROM \n\t\t\t\t\t[dbo].[DimMovies] mov \n\t\t\t\tJOIN\n\t\t\t\t\t[ext].[Catalog] cat \n\t\t\t\t\tON mov.MovieTitle = cat.Title \n\t\t\t\tWHERE\n\t\t\t\t\tstr.MovieID = cat.SourceSystemMovieID\n\t\t\t) AS MovieSK,\n\t\t\tstrstadat.DateSK AS StreamStartDateSK,\n\t\t\tstrstatim.TimeSK AS StreamStartTimeSK,\n\t\t\tstrenddat.DateSK AS StreamEndDateSk,\n\t\t\tstrendtim.TimeSK AS StreamEndTimeSk,\n\t\t\tDATEDIFF(second, StreamStart, StreamEnd) AS StreamDurationSec,\n\t\t\tconvert(DECIMAL(9,4), DATEDIFF(second, StreamStart, StreamEnd) / 60.0) AS StreamDurationMin\n\t\tFROM\n\t\t\t[ext].[Streaming] str\n\t\tLEFT JOIN\n\t\t\t[dbo].[DimDate] strstadat\n\t\t\tON convert(date, str.StreamStart) = strstadat.DateValue\n\t\tLEFT JOIN\n\t\t\t[dbo].[DimTime] strstatim\n\t\t\tON convert(time, str.StreamStart) = strstatim.TimeValue\n\t\tLEFT JOIN\n\t\t\t[dbo].[DimDate] strenddat\n\t\t\tON convert(date, str.StreamEnd) = strenddat.DateValue\n\t\tLEFT JOIN\n\t\t\t[dbo].[DimTime] strendtim\n\t\t\tON convert(time, str.StreamEnd) = strendtim.TimeValue\n\t) ExternalTable\n) CleansedTable\nWHERE CleansedTable.TransactionID NOT IN (SELECT TransactionID FROM [dbo].[FactStreaming])\n\n-- Check Load\nSELECT COUNT(*) FROM [dbo].[FactStreaming]\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Movies",
				"databaseName": "Movies"
			}
		},
		"type": "SqlQuery"
	}
}