{
	"name": "MOV_SQL_050409_LoadTables_FactSales",
	"properties": {
		"description": "OpenHack MDWH\nAzure Synapse Analytics Demo\nhttps://github.com/aessing/demo-azuresynapse\n\nDeveloper: Andre Essing\n(https://www.andre-essing.de/)\n(https://github.com/aessing)\n(https://twitter.com/aessing)\n(https://www.linkedin.com/in/aessing/)\n\nTHIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\nEITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\nWARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.",
		"folder": {
			"name": "Movies/Challenge 05 - 04 Load Tables"
		},
		"content": {
			"query": "-- =============================================================================\n-- OpenHack MDWH\n-- Azure Synapse Analytics Demo\n-- https://github.com/aessing/demo-azuresynapse\n-- -----------------------------------------------------------------------------\n-- Developer.......: Andre Essing (https://www.andre-essing.de/)\n--                                (https://github.com/aessing)\n--                                (https://twitter.com/aessing)\n--                                (https://www.linkedin.com/in/aessing/)\n-- -----------------------------------------------------------------------------\n-- THIS CODE AND INFORMATION ARE PROVIDED \"AS IS\" WITHOUT WARRANTY OF ANY KIND,\n-- EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED\n-- WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.\n-- =============================================================================\n\n-- TRUNCATE TABLE [dbo].[FactSales];\n\n-- Load table\nDECLARE @MaxSK INT;\nSELECT @MaxSK = ISNULL(MAX(SalesSK), 0) FROM [dbo].[FactSales]\n\nINSERT INTO [dbo].[FactSales] (\n    [SalesSK],\n    [OrderID],\n    [LineNumber],\n    [OrderDateSK],\n    [ShipDateSK],\n    [CustomerSK],\n    [LocationSK],\n    [MovieSK],\n    [DaysToShip],\n    [Quantity],\n    [UnitCost],\n    [ExtendedCost]\n)\nSELECT * FROM (\n\tSELECT \n\t\t@MaxSK + ROW_NUMBER() OVER (ORDER BY ExternalTable.OrderID) AS SalesSK,\n\t\tExternalTable.OrderID AS OrderID,\n\t\tExternalTable.LineNumber AS LineNumber,\n\t\tExternalTable.OrderDateSK AS OrderDateSK,\n\t\tExternalTable.ShipDateSK AS ShipDateSK,\n\t\tExternalTable.CustomerSK AS CustomerSK,\n\t\tExternalTable.LocationSK AS LocationSK,\n\t\tExternalTable.MovieSK AS MovieSK,\n\t\tExternalTable.DaysToShip AS DaysToShip,\n\t\tExternalTable.Quantity AS Quantity,\n\t\tExternalTable.UnitCost AS UnitCost,\n\t\tExternalTable.ExtendedCost AS ExtendedCost\n\tFROM (\n\t\tSELECT\n\t\t\tSourceSystemOrderID AS OrderID,\n\t\t\tLineNumber,\n\t\t\torddat.DateSK AS OrderDateSK,\n\t\t\tshidat.DateSK AS ShipDateSK,\n\t\t\t(\n\t\t\t\tSELECT TOP 1\n\t\t\t\t\tCustomerSK \n\t\t\t\tFROM \n\t\t\t\t\t[dbo].[DimCustomers] dcust\n\t\t\t\tJOIN\n\t\t\t\t\t[ext].[Customers] cust\n\t\t\t\t\tON dcust.LastName = cust.LastName\n\t\t\t\t\tAND dcust.FirstName = cust.FirstName\n\t\t\t\t\tAND dcust.ZipCode = cust.ZipCode\n\t\t\t\t\tAND dcust.City = cust.City\n\t\t\t\t\tAND dcust.State = cust.State\n\t\t\t\tWHERE\n\t\t\t\t\tsal.CustomerID = cust.SourceSystemCustomerID\n\t\t\t) AS CustomerSK,\n\t\t\tSourceSystemID AS LocationSK,\n\t\t\t(\n\t\t\t\tSELECT TOP 1\n\t\t\t\t\tMovieSK \n\t\t\t\tFROM \n\t\t\t\t\t[dbo].[DimMovies] mov \n\t\t\t\tJOIN\n\t\t\t\t\t[ext].[Catalog] cat \n\t\t\t\t\tON mov.MovieTitle = cat.Title \n\t\t\t\tWHERE\n\t\t\t\t\tsal.MovieID = cat.SourceSystemMovieID\n\t\t\t) AS MovieSK,\n\t\t\tCASE\n\t\t\t\tWHEN DATEDIFF(d, sal.OrderDate, sal.ShipDate) < 0 THEN NULL\n\t\t\t\tELSE DATEDIFF(d, sal.OrderDate, sal.ShipDate)\n\t\t\tEND AS DaysToShip,\n\t\t\tQuantity,\n\t\t\tUnitCost,\n\t\t\tQuantity * UnitCost AS ExtendedCost \n\t\tFROM\n\t\t\t[ext].[Sales] sal \n\t\tLEFT JOIN\n\t\t\t[dbo].[DimDate] orddat\n\t\t\tON sal.OrderDate = orddat.DateValue\n\t\tLEFT JOIN\n\t\t\t[dbo].[DimDate] shidat\n\t\t\tON sal.ShipDate = shidat.DateValue\n\t) ExternalTable\n) CleansedTable\nWHERE CleansedTable.OrderID NOT IN (SELECT OrderID FROM [dbo].[FactSales])\n\n-- Check Load\n/*\nSELECT COUNT(*) FROM [ext].[sales]\nUNION ALL\nSELECT COUNT(*) FROM [dbo].[FactSales]\n*/",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "Movies",
				"databaseName": "Movies"
			}
		},
		"type": "SqlQuery"
	}
}